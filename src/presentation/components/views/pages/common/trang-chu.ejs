<%- contentFor('body') %>
<!-- Ph·∫ßn t√¨m ki·∫øm -->
<section class="py-4 bg-secondary bg-opacity-10">
<div class="container">
    <div class="mb-3">
      <h5 class="mb-2">T√¨m ki·∫øm</h5>
      <form id="search-form" action="/viec-lam" method="GET">
        <div class="input-group">
          <input type="text" class="form-control" id="search-input" name="keyword" placeholder="T√¨m ki·∫øm theo v·ªã tr√≠, c√¥ng ty..." aria-label="T√¨m ki·∫øm">
          <button class="btn btn-primary" type="submit" id="tim-kiem">
            <i class="fas fa-search"></i> T√¨m ki·∫øm
          </button>
        </div>
      </form>
    </div>
    
    <div class="d-flex flex-wrap align-items-center">
      <span class="text-muted me-2 small">B·ªô l·ªçc t·ªët nh·∫•t:</span>
      <div class="d-flex flex-wrap gap-1">
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="React">React</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="Java">Java</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="JavaScript">JavaScript</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="UI/UX">UI/UX</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="C#">C#</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="DevOps">DevOps</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill filter-btn" data-keyword="Python">Python</button>
      </div>
    </div>
  </div>
</section>

<!-- C√¥ng Ty N·ªïi B·∫≠t - Ki·ªÉu hi·ªÉn th·ªã m·ªõi -->
<section class="py-4 bg-light">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="text-primary text-center mb-0">C√¥ng Ty N·ªïi B·∫≠t</h3>
    </div>
    
    <!-- Container c√≥ th·ªÉ cu·ªôn ngang v·ªõi ƒëi·ªÅu h∆∞·ªõng -->
    <div class="position-relative">
      <!-- M≈©i t√™n tr√°i -->
      <div class="position-absolute top-50 start-0 translate-middle-y" style="z-index: 10; left: -10px;">
        <button class="btn btn-light rounded-circle shadow-sm" id="scrollLeftBtn">
          <i class="fas fa-chevron-left"></i>
        </button>
    </div>
    
    <!-- Container c√≥ th·ªÉ cu·ªôn ngang -->
    <div class="row flex-nowrap overflow-auto" id="featuredCompaniesContainer" style="-webkit-overflow-scrolling: touch; scroll-behavior: smooth;">
      <% if (typeof featuredCompanies !== 'undefined' && featuredCompanies.length > 0) { %>
        <% featuredCompanies.forEach(function(company) { %>
          <!-- Ki·ªÉm tra th√¥ng tin c√¥ng ty -->
          <% if (company && company.thongTin) { %>
          <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm border">
              <!-- ·∫¢nh n·ªÅn t·ª´ tr∆∞·ªùng anh -->
              <div class="position-relative" style="height: 160px; overflow: hidden;">
                <img src="<%= (company.thongTin && company.thongTin.anh) ? company.thongTin.anh : (defaultBanner || '/images/kg_banner.jpg') %>" 
                    alt="<%= (company.thongTin && company.thongTin.tenCongTy) ? company.thongTin.tenCongTy : 'C√¥ng ty' %>" 
                    class="card-img-top w-100 h-100" 
                    style="object-fit: cover;">
                <div class="position-absolute" style="top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3);"></div>
              </div>
              
              <div class="card-body">
                <!-- Logo v√† t√™n c√¥ng ty c√πng h√†ng -->
                <div class="d-flex align-items-center mb-3">
                  <img src="<%= (company.thongTin && company.thongTin.logo) ? company.thongTin.logo : (defaultLogo || '/images/kg_logo.jpg') %>" 
                      alt="<%= (company.thongTin && company.thongTin.tenCongTy) ? company.thongTin.tenCongTy : 'Logo' %>" 
                      class="me-3" 
                      style="width: 80px; height: 80px; object-fit: contain;">
                  <div>
                    <h5 class="mb-0"><%= (company.thongTin && company.thongTin.tenCongTy) ? company.thongTin.tenCongTy : 'C√¥ng ty' %></h5>
                    <p class="text-muted small mb-0"><%= (company.thongTin && (company.thongTin.nganhNghe || company.thongTin.linhVuc)) ? (company.thongTin.nganhNghe || company.thongTin.linhVuc) : 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                  </div>
                </div>
                
                <!-- M√¥ t·∫£ c√¥ng ty -->
                <p class="small mb-3">
                  <% 
                    let moTa = 'Ch∆∞a c√≥ m√¥ t·∫£ c√¥ng ty.';
                    if (company.thongTin) {
                      if (company.thongTin.moTa) moTa = company.thongTin.moTa;
                      else if (company.thongTin.moTaCty) moTa = company.thongTin.moTaCty;
                    }
                    if (moTa && moTa.length > 100) moTa = moTa.substring(0, 100) + '...';
                  %>
                  <%= moTa %>
                </p>
                <div class="text-center">
                  <a href="/chi-tiet-cong-ty/<%= company._id %>" class="btn btn-sm btn-outline-primary">T√¨m hi·ªÉu th√™m</a>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else { %>
        <!-- Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng c√≥ c√¥ng ty n√†o -->
        <div class="col-md-4 mb-3">
          <div class="card h-100 shadow-sm border">
            <div class="position-relative" style="height: 160px; overflow: hidden;">
              <img src="<%= defaultBanner || '/images/kg_banner.jpg' %>" 
                  alt="C√¥ng ty m·∫´u" 
                  class="card-img-top w-100 h-100" 
                  style="object-fit: cover;">
              <div class="position-absolute" style="top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3);"></div>
            </div>
            
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                <img src="<%= defaultLogo || '/images/kg_logo.jpg' %>" 
                    alt="K&G Technology" 
                    class="me-3" 
                    style="width: 80px; height: 80px; object-fit: contain;">
                <div>
                  <h5 class="mb-0">MB Bank</h5>
                  <p class="text-muted small mb-0">Ng√¢n h√†ng</p>
                </div>
              </div>
              
              <p class="small mb-3">MB l√† ng√¢n h√†ng th∆∞∆°ng m·∫°i h√†ng ƒë·∫ßu Vi·ªát Nam v·ªõi d·ªãch v·ª• t√†i ch√≠nh ƒëa d·∫°ng...</p>
              <div class="text-center">
                <a href="#" class="btn btn-sm btn-outline-primary">T√¨m hi·ªÉu th√™m</a>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
    
      <!-- M≈©i t√™n ph·∫£i -->
      <div class="position-absolute top-50 end-0 translate-middle-y" style="z-index: 10; right: -10px;">
        <button class="btn btn-light rounded-circle shadow-sm" id="scrollRightBtn">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    
    <!-- Indicators - ƒë·∫∑t ·ªü gi·ªØa -->
    <div class="d-flex justify-content-center mt-3">
      <button type="button" class="btn btn-sm btn-primary mx-1 active"></button>
      <button type="button" class="btn btn-sm btn-outline-primary mx-1"></button>
      <button type="button" class="btn btn-sm btn-outline-primary mx-1"></button>
    </div>
  </div>
</section>
    
<!-- Nh√† tuy·ªÉn d·ª•ng n·ªïi b·∫≠t -->
<section class="py-4 border-bottom">
  <div class="container">
    <h3 class="text-primary mb-4">Nh√† Tuy·ªÉn D·ª•ng N·ªïi B·∫≠t</h3>
    <div class="position-relative employer-logos">
      <!-- M≈©i t√™n tr√°i -->
      <div class="position-absolute top-50 start-0 translate-middle-y" style="z-index: 10; left: -10px;">
        <button class="btn btn-light rounded-circle shadow-sm" id="prevEmployer">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>
      
      <!-- Danh s√°ch nh√† tuy·ªÉn d·ª•ng n·ªïi b·∫≠t - L·∫•y t·ª´ database -->
      <div class="d-flex flex-nowrap justify-content-between align-items-center overflow-auto" id="employerLogosContainer" style="-webkit-overflow-scrolling: touch; scroll-behavior: smooth;">
        <% if (typeof featuredEmployers !== 'undefined' && featuredEmployers.length > 0) { %>
          <% featuredEmployers.forEach(function(employer) { %>
            <% if (employer && employer.thongTin) { %>
            <div class="mx-3 my-2">
              <a href="/chi-tiet-cong-ty/<%= employer._id %>">
                <img src="<%= (employer.thongTin && employer.thongTin.logo) ? employer.thongTin.logo : (defaultLogo || '/images/kg_logo.jpg') %>" 
                     alt="<%= (employer.thongTin && employer.thongTin.tenCongTy) ? employer.thongTin.tenCongTy : 'Logo' %>" 
                     height="60" 
                     style="min-width: 150px; object-fit: contain;">
              </a>
            </div>
            <% } %>
          <% }); %>
        <% } else { %>
          <!-- D·ªØ li·ªáu m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ nh√† tuy·ªÉn d·ª•ng n·ªïi b·∫≠t trong database -->
        <div class="mx-3 my-2">
            <img src="https://placehold.co/150x60/EEE/31343C?text=PRIME+TECH" alt="PRIME TECH" height="60">
        </div>
        <div class="mx-3 my-2">
            <img src="https://placehold.co/150x60/EEE/31343C?text=MOTOROLA" alt="MOTOROLA" height="60">
        </div>
        <div class="mx-3 my-2">
            <img src="https://placehold.co/150x60/EEE/31343C?text=ROADMAP+AI" alt="ROADMAP AI" height="60">
        </div>
        <div class="mx-3 my-2">
          <img src="https://placehold.co/150x60/EEE/31343C?text=Sacombank" alt="Sacombank" height="60">
        </div>
        <div class="mx-3 my-2">
          <img src="https://placehold.co/150x60/EEE/31343C?text=GEM" alt="GEM" height="60">
        </div>
        <div class="mx-3 my-2">
          <img src="https://placehold.co/150x60/EEE/31343C?text=ACB" alt="ACB" height="60">
        </div>
        <% } %>
      </div>
      
      <!-- M≈©i t√™n ph·∫£i -->
      <div class="position-absolute top-50 end-0 translate-middle-y" style="z-index: 10; right: -10px;">
        <button class="btn btn-light rounded-circle shadow-sm" id="nextEmployer">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Vi·ªác l√†m ƒë√£ l∆∞u -->
<section class="py-4" style="background-color: #d5d5d5;">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="text-primary">Vi·ªác L√†m ƒê√£ L∆∞u</h3>
      <a href="/viec-lam-da-luu" class="text-decoration-none text-primary">XEM T·∫§T C·∫¢</a>
    </div>
    
    <div class="row">
      <% if (typeof savedJobs !== 'undefined' && savedJobs.length > 0) { %>
        <% savedJobs.forEach(function(job) { %>
          <% if (job) { %>
          <div class="col-md-4 mb-3">
            <div class="saved-job-item">
              <div class="job-logo-bg">
                <% 
                  let logoUrl = 'https://placehold.co/150x60/EEE/31343C?text=Logo';
                  if (job.nhaTuyenDung && job.nhaTuyenDung.thongTin && job.nhaTuyenDung.thongTin.logo) {
                    logoUrl = job.nhaTuyenDung.thongTin.logo;
                  }
                %>
                <img src="<%= logoUrl %>" alt="<%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Logo c√¥ng ty' %>">
              </div>
              <div class="job-content">
                <h5 class="job-title"><a href="/chi-tiet-cong-viec/<%= job._id %>" class="text-decoration-none text-dark"><%= job.tenCV %></a></h5>
                <p class="company-name"><%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                <p class="job-location"><%= job.diaDiem || 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                <p class="job-salary text-primary"><%= job.luong ? (job.luong/1000000).toFixed(0) + ' tri·ªáu/th√°ng' : 'Th∆∞∆°ng l∆∞·ª£ng' %></p>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else if (typeof user !== 'undefined' && user) { %>
        <!-- Kh√¥ng c√≥ vi·ªác l√†m ƒë√£ l∆∞u -->
        <div class="col-12 text-center py-5">
          <div class="py-5">
            <i class="far fa-bookmark fa-4x mb-3 text-muted"></i>
            <h5 class="text-muted">B·∫°n ch∆∞a l∆∞u c√¥ng vi·ªác n√†o</h5>
            <p class="text-muted">H√£y kh√°m ph√° c√°c c√¥ng vi·ªác v√† l∆∞u l·∫°i nh·ªØng c√¥ng vi·ªác b·∫°n quan t√¢m</p>
            <a href="/viec-lam" class="btn btn-primary mt-2">T√¨m vi·ªác l√†m ngay</a>
          </div>
        </div>
      <% } else { %>
        <!-- D·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng ƒëƒÉng nh·∫≠p ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu -->
        <div class="col-md-4 mb-3">
          <div class="saved-job-item">
            <div class="job-logo-bg">
              <img src="https://placehold.co/150x60/EEE/31343C?text=Logo" alt="Personifeye">
            </div>
            <div class="job-content">
              <h5 class="job-title">Nh√¢n Vi√™n ChƒÉm S√≥c Kh√°ch H√†ng</h5>
              <p class="company-name">C√¥ng Ty CP Th∆∞∆°ng M·∫°i V√† T∆∞ V·∫•n</p>
              <p class="salary-range">10tr-12tr ƒë/th√°ng</p>
              <p class="job-location">H√† N·ªôi</p>
              <p class="job-salary text-primary">Th∆∞∆°ng l∆∞·ª£ng</p>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</section>

<!-- C√¥ng vi·ªác hot h√¥m nay -->
<section class="py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-primary mb-0">üî• C√¥ng Vi·ªác Hot H√¥m Nay</h3>
      <a href="/cong-viec-hot" class="text-decoration-none">Xem t·∫•t c·∫£</a>
    </div>
    <div class="row">
      <% if (typeof hotJobs !== 'undefined' && hotJobs.length > 0) { %>
        <% hotJobs.forEach(function(job) { %>
          <% if (job) { %>
          <div class="col-md-4 mb-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <% 
                    let logoUrl = 'https://placehold.co/40x40/EEE/31343C?text=Logo';
                    if (job.nhaTuyenDung && job.nhaTuyenDung.thongTin && job.nhaTuyenDung.thongTin.logo) {
                      logoUrl = job.nhaTuyenDung.thongTin.logo;
                    }
                  %>
                  <img src="<%= logoUrl %>" 
                       alt="<%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Logo' %>" 
                       height="40" style="object-fit: contain;">
                  <% const maCV = job._id ? job._id.toString() : ''; %>
                  <button class="btn btn-sm btn-outline-secondary border-0 btn-bookmark" 
                           data-job-id="<%= maCV %>" 
                           data-ma-cv="<%= maCV %>"
                           onclick="console.log('DEBUG - Job ID t·ª´ onClick:', '<%= maCV %>');">
                    <i class="<%= locals.user && locals.user.vaiTro === 'UngVien' && job.daLuu ? 'fas fa-heart text-danger' : 'far fa-bookmark' %>"></i>
                    <span class="visually-hidden">L∆∞u vi·ªác l√†m</span>
                  </button>
                </div>
                <h5 class="mt-3"><a href="/chi-tiet-cong-viec/<%= job._id %>" class="text-decoration-none text-dark"><%= job.tenCV %></a></h5>
                <p class="text-muted small"><%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                <div class="d-flex flex-wrap mt-3 gap-1">
                  <% if (job.kyNang && job.kyNang.length > 0) { %>
                    <% job.kyNang.forEach(function(skill, index) { %>
                      <% if (index < 5) { %>
                        <span class="badge bg-light text-dark"><%= skill %></span>
                      <% } %>
                    <% }); %>
                  <% } else { %>
                    <span class="badge bg-light text-dark">Ch∆∞a c·∫≠p nh·∫≠t</span>
                  <% } %>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <span class="text-danger fw-bold"><%= job.luong ? (job.luong/1000000).toFixed(0) + ' tri·ªáu/th√°ng' : 'Th·ªèa thu·∫≠n' %></span>
                  <span class="text-muted small"><%= job.diaDiem || 'Ch∆∞a c·∫≠p nh·∫≠t' %></span>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else { %>
        <!-- Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng c√≥ c√¥ng vi·ªác hot -->
        <div class="col-md-4 mb-3">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <img src="https://placehold.co/40x40/EEE/31343C?text=Prime" alt="Prime Tech" height="40">
                <button class="btn btn-sm btn-outline-secondary border-0"><i class="far fa-bookmark"></i></button>
              </div>
              <h5 class="mt-3">Senior Fullstack Developer</h5>
              <p class="text-muted small">PRIME TECH SOLUTION COMPANY LIMITED</p>
              <div class="d-flex flex-wrap mt-3 gap-1">
                <span class="badge bg-light text-dark">Agile</span>
                <span class="badge bg-light text-dark">Java</span>
                <span class="badge bg-light text-dark">Full-Stack</span>
                <span class="badge bg-light text-dark">DevOps</span>
              </div>
              <div class="d-flex flex-wrap mt-2 gap-1">
                <span class="badge bg-light text-dark">ReactJS</span>
                <span class="badge bg-light text-dark">Angular</span>
                <span class="badge bg-light text-dark">Spring Boot</span>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1 active">1</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">2</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">3</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">4</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">5</button>
    </div>
  </div>
</section>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1 active">1</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">2</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">3</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">4</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">5</button>
            </div>
        </div>
    </section>
    
<!-- C√°c c√¥ng ty n·ªïi b·∫≠t -->
<section class="py-4 bg-light">
  <div class="container">
    <h3 class="text-primary mb-4">C√°c C√¥ng Ty N·ªïi B·∫≠t</h3>
    <div class="row">
      <% if (typeof popularCompanies !== 'undefined' && popularCompanies.length > 0) { %>
        <% popularCompanies.slice(0, 4).forEach(function(company) { %>
          <% if (company && company.thongTin) { %>
          <div class="col-md-3 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                  <img src="<%= (company.thongTin && company.thongTin.logo) ? company.thongTin.logo : 'https://placehold.co/40x40/EEE/31343C?text=Logo' %>" height="40" alt="<%= (company.thongTin && company.thongTin.tenCongTy) ? company.thongTin.tenCongTy : 'Logo c√¥ng ty' %>" style="object-fit: contain;">
                  <button class="btn btn-sm btn-outline-secondary border-0"><i class="far fa-bookmark"></i></button>
                </div>
                <h5 class="mb-2"><a href="/chi-tiet-cong-ty/<%= company._id %>" class="text-decoration-none text-dark"><%= company.thongTin.tenCongTy || 'C√¥ng ty' %></a></h5>
                <p class="text-muted small mb-2"><%= company.thongTin.nganhNghe || company.thongTin.linhVuc || 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                <div class="d-flex flex-wrap mt-3 gap-1">
                  <span class="badge bg-light text-dark"><%= company.thongTin.quyMo || 'Quy m√¥ c√¥ng ty' %></span>
                  <span class="badge bg-light text-dark"><%= company.thongTin.diaChi ? company.thongTin.diaChi.split(',')[0] : 'Vi·ªát Nam' %></span>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else { %>
        <div class="col-md-3 mb-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <img src="/images/kg_logo.jpg" height="40" alt="IT Support">
                <button class="btn btn-sm btn-outline-secondary border-0"><i class="far fa-bookmark"></i></button>
              </div>
              <h5 class="mb-2">IT Support HN - Authentication (English - Open to Freshers)</h5>
              <p class="text-muted small mb-2">AV VIETNAM CORPORATION</p>
              <div class="d-flex flex-wrap mt-3 gap-1">
                <span class="badge bg-light text-dark">IT Support</span>
                <span class="badge bg-light text-dark">Technical Support</span>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</section>

<!-- C√¥ng vi·ªác m·ªõi nh·∫•t -->
<section class="py-4 bg-light">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-primary mb-0">C√¥ng Vi·ªác M·ªõi Nh·∫•t</h3>
      <a href="/cong-viec-moi" class="text-decoration-none text-danger">Xem t·∫•t c·∫£</a>
    </div>
    <div class="row">
      <% if (typeof latestJobs !== 'undefined' && latestJobs.length > 0) { %>
        <% latestJobs.slice(0, 3).forEach(function(job) { %>
          <% if (job) { %>
          <div class="col-md-4 mb-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <% 
                    let logoUrl = 'https://placehold.co/40x40/EEE/31343C?text=Logo';
                    if (job.nhaTuyenDung && job.nhaTuyenDung.thongTin && job.nhaTuyenDung.thongTin.logo) {
                      logoUrl = job.nhaTuyenDung.thongTin.logo;
                    }
                  %>
                  <img src="<%= logoUrl %>" 
                       alt="<%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Logo c√¥ng ty' %>" 
                       class="me-2" 
                       style="width: 40px; height: 40px; object-fit: contain;">
                  <div>
                    <h6 class="mb-0"><a href="/chi-tiet-cong-viec/<%= job._id %>" class="text-decoration-none text-dark"><%= job.tenCV %></a></h6>
                    <small class="text-muted"><%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Ch∆∞a c·∫≠p nh·∫≠t' %></small>
                  </div>
                </div>
                <div class="d-flex flex-wrap mt-2 gap-1">
                  <% if (job.kyNang && job.kyNang.length > 0) { %>
                    <% job.kyNang.slice(0, 4).forEach(function(skill) { %>
                      <span class="badge bg-light text-dark"><%= skill %></span>
                    <% }); %>
                  <% } else { %>
                    <span class="badge bg-light text-dark">Ch∆∞a c·∫≠p nh·∫≠t</span>
                  <% } %>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <span class="text-danger"><%= job.luong ? (job.luong/1000000).toFixed(0) + ' tri·ªáu/th√°ng' : 'Th·ªèa thu·∫≠n' %></span>
                  <span class="text-muted small"><%= job.diaDiem || 'Ch∆∞a c·∫≠p nh·∫≠t' %></span>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else { %>
        <!-- Hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng c√≥ c√¥ng vi·ªác n√†o -->
        <div class="col-md-4 mb-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <img src="/images/kg_logo.jpg" alt="MB Bank" class="me-2" style="width: 40px; height: 40px; object-fit: contain;">
                <div>
                  <h6 class="mb-0">[Senior] K·ªπ s∆∞ ph√°t tri·ªÉn Mobile App</h6>
                  <small class="text-muted">MB BANK</small>
                </div>
              </div>
              <div class="d-flex flex-wrap mt-2 gap-1">
                <span class="badge bg-light text-dark">Swift</span>
                <span class="badge bg-light text-dark">Java</span>
                <span class="badge bg-light text-dark">React Native</span>
                <span class="badge bg-light text-dark">Kotlin</span>
              </div>
            </div>
          </div>
        </div>
      <% } %>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1 active">1</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">2</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">3</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">4</button>
    </div>
  </div>
</section>

<!-- Vi·ªác l√†m g·ª£i √Ω -->
<section class="py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-primary mb-0">Vi·ªác L√†m G·ª£i √ù</h3>
      <a href="/viec-lam-goi-y" class="text-decoration-none text-danger">Xem t·∫•t c·∫£</a>
    </div>
    <div class="row">
      <% if (typeof suggestedJobs !== 'undefined' && suggestedJobs.length > 0 && typeof user !== 'undefined' && user) { %>
        <% suggestedJobs.forEach(function(job) { %>
          <% if (job) { %>
          <div class="col-md-4 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <% 
                    let logoUrl = 'https://placehold.co/40x40/EEE/31343C?text=Logo';
                    if (job.nhaTuyenDung && job.nhaTuyenDung.thongTin && job.nhaTuyenDung.thongTin.logo) {
                      logoUrl = job.nhaTuyenDung.thongTin.logo;
                    }
                  %>
                  <img src="<%= logoUrl %>" class="me-2" alt="<%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Logo c√¥ng ty' %>" height="40" style="object-fit: contain;">
                  <% if (job.ngayDang && new Date(job.ngayDang).getTime() > Date.now() - 3*24*60*60*1000) { %>
                    <span class="badge bg-danger">M·ªõi</span>
                  <% } else if (job.isHot) { %>
                    <span class="badge bg-warning text-dark">N·ªïi b·∫≠t</span>
                  <% } else { %>
                    <span class="badge bg-primary">Ph√π h·ª£p</span>
                  <% } %>
                </div>
                <h5 class="mt-3"><a href="/chi-tiet-cong-viec/<%= job._id %>" class="text-decoration-none"><%= job.tenCV %></a></h5>
                <p class="text-muted small"><%= job.nhaTuyenDung && job.nhaTuyenDung.thongTin ? job.nhaTuyenDung.thongTin.tenCongTy : 'Ch∆∞a c·∫≠p nh·∫≠t' %></p>
                <div class="d-flex justify-content-between">
                  <span class="text-danger fw-bold"><%= job.luong ? (job.luong/1000000).toFixed(0) + ' tri·ªáu' : 'Th·ªèa thu·∫≠n' %></span>
                  <span class="text-muted small"><%= job.diaDiem || 'Ch∆∞a c·∫≠p nh·∫≠t' %></span>
                </div>
              </div>
            </div>
          </div>
          <% } %>
        <% }); %>
      <% } else { %>
        <!-- Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p -->
        <% if (!user) { %>
          <div class="col-12 text-center py-5">
            <div class="py-3">
              <i class="fas fa-user-lock fa-4x mb-3 text-muted"></i>
              <h5 class="text-muted">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem vi·ªác l√†m g·ª£i √Ω</h5>
              <p class="text-muted">Ch√∫ng t√¥i s·∫Ω g·ª£i √Ω c√°c c√¥ng vi·ªác ph√π h·ª£p d·ª±a tr√™n h·ªì s∆° v√† k·ªπ nƒÉng c·ªßa b·∫°n</p>
              <a href="/dang-nhap" class="btn btn-primary mt-2">ƒêƒÉng nh·∫≠p ngay</a>
            </div>
          </div>
        <% } else { %>
          <!-- D·ªØ li·ªáu m·∫´u n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p nh∆∞ng kh√¥ng c√≥ g·ª£i √Ω -->
          <div class="col-md-4 mb-3">
            <div class="card h-100 border-0 shadow-sm hover-shadow">
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <img src="/images/kg_logo.jpg" class="me-2" alt="FPT Retail" height="40">
                  <span class="badge bg-danger">M·ªõi</span>
                </div>
                <h5 class="mt-3"><a href="#" class="text-decoration-none">Ch·∫•t l∆∞·ª£ng h·ªá th·ªëng - C√¥ng ngh·ªá th√¥ng tin</a></h5>
                <p class="text-muted small">C√¥ng ty C·ªï ph·∫ßn B√°n l·∫ª K·ªπ thu·∫≠t s·ªë FPT</p>
                <div class="d-flex justify-content-between">
                  <span class="text-danger fw-bold">15-20 tri·ªáu</span>
                  <span class="text-muted small">H√† N·ªôi</span>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      <% } %>
    </div>
    <div class="text-center mt-2">
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1 active">1</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">2</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">3</button>
      <button type="button" class="btn btn-sm btn-outline-secondary mx-1">4</button>
    </div>
  </div>
</section>
        </div>
    </section>

<%- contentFor('extraJS') %>
<script>
  // ƒê·∫∑t bi·∫øn global v√†o ƒë·ªëi t∆∞·ª£ng window
  window.userLoggedIn = '<%= locals.user ? "true" : "false" %>';
  window.userIsUngVien = '<%= locals.user && locals.user.vaiTro === "UngVien" ? "true" : "false" %>';
  console.log('User Logged In:', window.userLoggedIn);
  console.log('User Is UngVien:', window.userIsUngVien);
  
  $(document).ready(function() {
    // Log th√¥ng tin khi trang ƒë∆∞·ª£c t·∫£i
    console.log("=== TRANG CH·ª¶ ƒê√É T·∫¢I XONG ===");
    
    // L·∫•y gi√° tr·ªã t·ª´ thu·ªôc t√≠nh data v√† ƒë·∫£m b·∫£o chuy·ªÉn ƒë·ªïi th√†nh boolean
    var userLoggedIn = $('body').data('user-logged-in') === true || $('body').data('user-logged-in') === "true";
    var userIsUngVien = $('body').data('user-is-ungvien') === true || $('body').data('user-is-ungvien') === "true";
    console.log('Body data attributes:', {
      'user-logged-in': $('body').data('user-logged-in'),
      'user-is-ungvien': $('body').data('user-is-ungvien')
    });
    
    // In ra t·∫•t c·∫£ c√°c n√∫t bookmark ƒë·ªÉ ki·ªÉm tra
    $('.btn-bookmark').each(function(index) {
      console.log(`N√∫t bookmark #${index}:`, {
        'jobId': $(this).data('job-id'),
        'html': $(this).html()
      });
    });
    
    // X·ª≠ l√Ω c√°c h√¨nh ·∫£nh b·ªã l·ªói
    $('img').on('error', function() {
      // Ki·ªÉm tra n·∫øu h√¨nh ·∫£nh ƒë√£ l√† placeholder th√¨ kh√¥ng x·ª≠ l√Ω n·ªØa ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
      if (!this.src.includes('placeholder')) {
        if ($(this).width() > 60) {
          // ·∫¢nh l·ªõn
          this.src = '/images/placeholder.jpg';
        } else {
          // Logo ho·∫∑c ·∫£nh nh·ªè
          this.src = '/images/kg_logo.jpg';
        }
      }
    });

    // X·ª≠ l√Ω n√∫t ƒëi·ªÅu h∆∞·ªõng cho ph·∫ßn c√¥ng ty n·ªïi b·∫≠t
    $('#scrollLeftBtn').on('click', function() {
      $('#featuredCompaniesContainer').animate({
        scrollLeft: '-=300'
      }, 300);
    });
    
    $('#scrollRightBtn').on('click', function() {
      $('#featuredCompaniesContainer').animate({
        scrollLeft: '+=300'
      }, 300);
    });
    
    // X·ª≠ l√Ω n√∫t ƒëi·ªÅu h∆∞·ªõng cho ph·∫ßn nh√† tuy·ªÉn d·ª•ng
    $('#prevEmployer').on('click', function() {
      // X·ª≠ l√Ω cu·ªôn danh s√°ch logo c√¥ng ty sang tr√°i
      $('.employer-logos .d-flex').animate({
        scrollLeft: '-=300'
      }, 300);
    });
    
    $('#nextEmployer').on('click', function() {
      // X·ª≠ l√Ω cu·ªôn danh s√°ch logo c√¥ng ty sang ph·∫£i
      $('.employer-logos .d-flex').animate({
        scrollLeft: '+=300'
      }, 300);
    });

    // X·ª≠ l√Ω n√∫t l∆∞u c√¥ng vi·ªác - s·ª≠ d·ª•ng delegate ƒë·ªÉ b·∫Øt event tr√™n t·∫•t c·∫£ n√∫t bookmark
    $(document).on('click', '.btn-bookmark', function(event) {
      event.preventDefault(); // NgƒÉn kh√¥ng cho browser x·ª≠ l√Ω m·∫∑c ƒë·ªãnh
      event.stopPropagation(); // NgƒÉn lan truy·ªÅn
      
      // Hi·ªÉn th·ªã alert ƒë·ªÉ x√°c nh·∫≠n s·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t
      // Thay th·∫ø alert b·∫±ng console.log tr·ª±c ti·∫øp
      console.log("üî¥ TRANG CH·ª¶: N√∫t bookmark ƒë∆∞·ª£c b·∫•m v√†o l√∫c", new Date().toISOString());
      
      // L·∫•y ID c√¥ng vi·ªác t·ª´ thu·ªôc t√≠nh data-ma-cv (∆∞u ti√™n) ho·∫∑c data-job-id
      // Th·ª≠ c·∫£ attr() v√† data() v√¨ ƒë√¥i khi jQuery x·ª≠ l√Ω kh√°c nhau
      var maCV = $(this).attr('data-ma-cv') || $(this).attr('data-job-id');
      if (!maCV) {
        maCV = $(this).data('ma-cv') || $(this).data('job-id');
      }
      
      console.log("üî¥ TRANG CH·ª¶: maCV:", maCV);
      console.log("üî¥ TRANG CH·ª¶: Ki·ªÉu d·ªØ li·ªáu c·ªßa maCV:", typeof maCV);
      
      // L·∫•y tr·ª±c ti·∫øp t·ª´ thu·ªôc t√≠nh c·ªßa element ƒë·ªÉ ki·ªÉm tra xem d·ªØ li·ªáu c√≥ ƒë√∫ng kh√¥ng
      var directAttr = this.getAttribute('data-ma-cv') || this.getAttribute('data-job-id');
      console.log("üî¥ TRANG CH·ª¶: Gi√° tr·ªã l·∫•y tr·ª±c ti·∫øp t·ª´ getAttribute:", directAttr);
      
      // N·∫øu v·∫´n kh√¥ng c√≥, th·ª≠ ƒë·ªçc t·ª´ HTML tr·ª±c ti·∫øp
      if (!maCV && !directAttr) {
        var htmlContent = $(this).html();
        console.log("üî¥ TRANG CH·ª¶: HTML c·ªßa n√∫t:", htmlContent);
        // T√¨m ki·∫øm ID trong c√°c thu·ªôc t√≠nh kh√°c
        var parentElement = $(this).closest('.job-item, .card');
        var possibleId = parentElement.find('a[href*="/chi-tiet-cong-viec/"]').attr('href');
        if (possibleId) {
          possibleId = possibleId.split('/').pop();
          console.log("üî¥ TRANG CH·ª¶: ID t√¨m t·ª´ URL chi ti·∫øt:", possibleId);
          maCV = possibleId;
        }
      }
      
      // Log t·∫•t c·∫£ c√°c thu·ªôc t√≠nh data c·ªßa n√∫t
      var allData = $(this).data();
      console.log("üî¥ TRANG CH·ª¶: T·∫§T C·∫¢ DATA ATTRIBUTES:", JSON.stringify(allData));
      
      // Ki·ªÉm tra l·∫°i gi√° tr·ªã maCV (ID c√¥ng vi·ªác)
      if (maCV === 'undefined' || maCV === '') {
        console.error("maCV kh√¥ng h·ª£p l·ªá");
        alert("Kh√¥ng th·ªÉ l∆∞u vi·ªác l√†m n√†y. ID c√¥ng vi·ªác kh√¥ng h·ª£p l·ªá!");
        return;
      }
      var btn = $(this);
      
      if (!maCV) {
        console.error("Kh√¥ng t√¨m th·∫•y ID c√¥ng vi·ªác (maCV)");
        alert("Kh√¥ng th·ªÉ l∆∞u vi·ªác l√†m n√†y. ID c√¥ng vi·ªác kh√¥ng h·ª£p l·ªá!");
        return;
      }
      
      // L·∫•y d·ªØ li·ªáu ƒëƒÉng nh·∫≠p t·ª´ data attribute v√† chuy·ªÉn th√†nh boolean
      var isLoggedIn = $('body').data('user-logged-in') === true || $('body').data('user-logged-in') === "true";
      var isUngVien = $('body').data('user-is-ungvien') === true || $('body').data('user-is-ungvien') === "true";
      
      // C√°ch kh√°c ƒë·ªÉ ki·ªÉm tra ƒëƒÉng nh·∫≠p t·ª´ bi·∫øn to√†n c·ª•c
      isLoggedIn = isLoggedIn || (window.userLoggedIn === "true");
      isUngVien = isUngVien || (window.userIsUngVien === "true");
      
      console.log("Tr·∫°ng th√°i ƒëƒÉng nh·∫≠p:", isLoggedIn, "L√† ·ª©ng vi√™n:", isUngVien);
      console.log("Th√¥ng tin window.userLoggedIn:", window.userLoggedIn);
      console.log("Th√¥ng tin window.userIsUngVien:", window.userIsUngVien);
      console.log("Data t·ª´ body:", $('body').data());
      
      if (!isLoggedIn) {
        window.location.href = '/dang-nhap?redirect=' + window.location.pathname;
        return;
      } else if (!isUngVien) {
        alert('Ch·ªâ t√†i kho·∫£n ·ª©ng vi√™n m·ªõi c√≥ th·ªÉ l∆∞u vi·ªác l√†m!');
        return;
      }
      
      // Ki·ªÉm tra l·∫°i maCV tr∆∞·ªõc khi g·ª≠i request
      if (!maCV) {
        console.error("L·ªói kh√¥ng c√≥ maCV");
        alert("L·ªói: kh√¥ng c√≥ ID c√¥ng vi·ªác!");
        return;
      }
      
      // Log chi ti·∫øt tr∆∞·ªõc khi g·ª≠i request
      console.log("Chu·∫©n b·ªã g·ª≠i request AJAX v·ªõi maCV:", maCV);
      
      // Th·ª≠ ki·ªÉm tra v√† l√†m s·∫°ch maCV n·∫øu c·∫ßn
      if (typeof maCV === 'string') {
        // Lo·∫°i b·ªè c√°c k√Ω t·ª± kh√¥ng c·∫ßn thi·∫øt n·∫øu c√≥
        maCV = maCV.trim();
      }
      
      // C·ªë g·∫Øng chuy·ªÉn ƒë·ªïi maCV th√†nh ObjectId format n·∫øu ch∆∞a ƒë√∫ng ƒë·ªãnh d·∫°ng
      if (maCV && typeof maCV === 'string' && !maCV.match(/^[0-9a-fA-F]{24}$/)) {
        console.log("maCV kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng MongoDB ObjectId, ƒëang c·ªë g·∫Øng chu·∫©n h√≥a");
        // N·∫øu l√† m·ªôt chu·ªói JSON, th·ª≠ parse
        try {
          const parsedValue = JSON.parse(maCV);
          if (parsedValue && typeof parsedValue === 'string') {
            maCV = parsedValue;
          }
        } catch (e) {
          console.log("Kh√¥ng ph·∫£i chu·ªói JSON h·ª£p l·ªá:", e);
        }
        console.log("Sau khi chu·∫©n h√≥a, maCV:", maCV);
      }
      
      // T·∫°o d·ªØ li·ªáu ƒë√∫ng theo c·∫•u tr√∫c CSDL (maCV, maND)
      const payload = { maCV: maCV };
      console.log("DEBUG TRANG CH·ª¶ - D·ªØ li·ªáu s·∫Ω g·ª≠i:", payload);
      const jsonData = JSON.stringify(payload);
      console.log("DEBUG TRANG CH·ª¶ - D·ªØ li·ªáu sau khi stringify:", jsonData);
      
      // Th√™m log chi ti·∫øt khi b·∫•m n√∫t
      console.log("DEBUG TRANG CH·ª¶ - B·∫•m n√∫t l∆∞u vi·ªác l√†m y√™u th√≠ch - timestamp:", new Date().toISOString());
      
      console.log("ƒêang g·ª≠i y√™u c·∫ßu l∆∞u c√¥ng vi·ªác c√≥ ID:", maCV);
      
      // Ki·ªÉm tra cookie session
      console.log("COOKIE SESSION:", document.cookie);
      
      // In ra payload cu·ªëi c√πng ƒë·ªÉ ki·ªÉm tra
      console.log("PAYLOAD FINAL (DEBUG):", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'include', // ƒê·∫£m b·∫£o cookie ƒë∆∞·ª£c g·ª≠i
        body: jsonData
      });

      // Thay ƒë·ªïi API URL ƒë·ªÉ kh·ªõp v·ªõi route
      var apiUrl = '/api/viec-yeu-thich';
      console.log("API URL:" + apiUrl);

      // S·ª≠ d·ª•ng form data thay v√¨ JSON ƒë·ªÉ xem c√≥ kh·∫Øc ph·ª•c ƒë∆∞·ª£c v·∫•n ƒë·ªÅ kh√¥ng
      var formData = new FormData();
      formData.append('maCV', maCV);
      
      // Log form data
      console.log("Form data created with maCV:", maCV);
      
      // S·ª≠ d·ª•ng fetch API v·ªõi credentials: 'include'
      console.log("üîµ B∆Ø·ªöC 1: B·∫Øt ƒë·∫ßu g·ª≠i request fetch API v·ªõi credentials: include");
      console.log("üîµ B∆Ø·ªöC 1: Th·ªùi gian:", new Date().toISOString());
      console.log("üîµ B∆Ø·ªöC 1: URL:", apiUrl);
      console.log("üîµ B∆Ø·ªöC 1: Method:", "POST");
      console.log("üîµ B∆Ø·ªöC 1: Headers:", {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      });
      console.log("üîµ B∆Ø·ªöC 1: Body:", jsonData);
      console.log("üîµ B∆Ø·ªöC 1: Credentials:", 'include');
      
      // Th√™m timestamp ƒë·ªÉ tr√°nh cache
      const timestampedUrl = apiUrl + '?t=' + new Date().getTime();
      
      fetch(timestampedUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        },
        credentials: 'include', // ƒê·∫£m b·∫£o cookie ƒë∆∞·ª£c g·ª≠i ƒëi
        body: jsonData
      })
      .then(response => {
        console.log("üîµ B∆Ø·ªöC 2: Nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ server");
        console.log("üîµ B∆Ø·ªöC 2: Status:", response.status);
        console.log("üîµ B∆Ø·ªöC 2: Status Text:", response.statusText);
        console.log("üîµ B∆Ø·ªöC 2: Headers:", [...response.headers.entries()]);
        console.log("üîµ B∆Ø·ªöC 2: Type:", response.type);
        console.log("üîµ B∆Ø·ªöC 2: URL:", response.url);
        console.log("üîµ B∆Ø·ªöC 2: Response OK:", response.ok);
        
        if (response.ok) {
          console.log("üîµ B∆Ø·ªöC 3A: Ph·∫£n h·ªìi th√†nh c√¥ng, ƒëang parse JSON");
          return response.json();
        }
        
        // X·ª≠ l√Ω c√°c l·ªói HTTP
        if (response.status === 401) {
          console.log("üîµ B∆Ø·ªöC 3B: L·ªói 401 - Ch∆∞a ƒëƒÉng nh·∫≠p");
          alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.');
          window.location.href = '/dang-nhap?redirect=' + window.location.pathname;
          throw new Error('Ch∆∞a ƒëƒÉng nh·∫≠p');
        } else if (response.status === 400) {
          console.log("üîµ B∆Ø·ªöC 3C: L·ªói 400 - Bad Request");
          return response.text().then(text => {
            console.log("üîµ B∆Ø·ªöC 3C: N·ªôi dung l·ªói:", text);
            if (text.includes('ƒë√£ ƒë∆∞·ª£c l∆∞u')) {
              console.log("üîµ B∆Ø·ªöC 3C: C√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c l∆∞u tr∆∞·ªõc ƒë√≥");
              alert('Vi·ªác l√†m n√†y ƒë√£ ƒë∆∞·ª£c l∆∞u tr∆∞·ªõc ƒë√≥');
              btn.html('<i class="fas fa-heart text-danger"></i>');
              btn.prop('disabled', true);
            }
            throw new Error(text);
          });
        }
        
        console.log("üîµ B∆Ø·ªöC 3D: L·ªói server kh√°c:", response.status);
        throw new Error('L·ªói m√°y ch·ªß ' + response.status);
      })
      .then(data => {
        console.log("üîµ B∆Ø·ªöC 4: L∆∞u c√¥ng vi·ªác th√†nh c√¥ng");
        console.log("üîµ B∆Ø·ªöC 4: D·ªØ li·ªáu ph·∫£n h·ªìi:", data);
        console.log("üîµ B∆Ø·ªöC 4: Th·ªùi gian:", new Date().toISOString());
        
        // C·∫≠p nh·∫≠t giao di·ªán
        alert("ƒê√£ l∆∞u c√¥ng vi·ªác th√†nh c√¥ng!");
        btn.html('<i class="fas fa-heart text-danger"></i>');
        btn.prop('disabled', true);
        
        console.log("üîµ B∆Ø·ªöC 5: Ho√†n th√†nh x·ª≠ l√Ω");
      })
      .catch(error => {
        console.error("üîµ L·ªñI: Fetch API error:", error);
        console.error("üîµ L·ªñI: Error message:", error.message);
        console.error("üîµ L·ªñI: Error stack:", error.stack);
        console.error("üîµ L·ªñI: Th·ªùi gian:", new Date().toISOString());
        
        // N·∫øu kh√¥ng ph·∫£i l·ªói ƒë√£ x·ª≠ l√Ω ·ªü tr√™n, th·ª≠ d√πng AJAX
        if (!error.message.includes('Ch∆∞a ƒëƒÉng nh·∫≠p') && 
            !error.message.includes('ƒë√£ ƒë∆∞·ª£c l∆∞u')) {
          
          console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 1: Th·ª≠ l·∫°i v·ªõi jQuery AJAX khi fetch th·∫•t b·∫°i");
          console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 1: URL:", apiUrl);
          console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 1: Data:", jsonData);
          
          // Th√™m timestamp ƒë·ªÉ tr√°nh cache
          const ajaxUrl = apiUrl + '?t=' + new Date().getTime();
          
          $.ajax({
            url: ajaxUrl,
            method: 'POST',
            contentType: 'application/json',
            data: jsonData,
            xhrFields: {
              withCredentials: true
            },
            crossDomain: false,
            beforeSend: function(xhr) {
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 2: G·ª≠i request AJAX");
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 2: Headers:", xhr.getAllResponseHeaders());
              // Th√™m c√°c header ƒë·ªÉ tr√°nh cache
              xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
              xhr.setRequestHeader('Pragma', 'no-cache');
              xhr.setRequestHeader('Expires', '0');
            },
            success: function(data, textStatus, xhr) {
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 3: AJAX th√†nh c√¥ng");
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 3: Status:", textStatus);
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 3: Status code:", xhr.status);
              console.log("üîµ B∆Ø·ªöC PH·ª§C H·ªíI 3: Response:", data);
              
              alert("ƒê√£ l∆∞u c√¥ng vi·ªác th√†nh c√¥ng!");
              btn.html('<i class="fas fa-heart text-danger"></i>');
              btn.prop('disabled', true);
            },
            error: function(xhr, status, error) {
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: AJAX l·ªói");
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Status:", status);
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Error:", error);
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Status code:", xhr.status);
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Status text:", xhr.statusText);
              console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Response text:", xhr.responseText);
              
              // Th·ª≠ ph√¢n t√≠ch ph·∫£n h·ªìi
              try {
                const responseObj = JSON.parse(xhr.responseText);
                console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Parsed response:", responseObj);
              } catch (e) {
                console.error("üîµ B∆Ø·ªöC PH·ª§C H·ªíI L·ªñI: Kh√¥ng th·ªÉ parse JSON response");
              }
              
              alert("L·ªói khi l∆∞u c√¥ng vi·ªác: " + (xhr.responseText || xhr.statusText || error));
            }
          });
        }
      });
    });

    // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫•n v√†o c√°c n√∫t b·ªô l·ªçc
    $('.filter-btn').on('click', function() {
      var keyword = $(this).data('keyword');
      $('#search-input').val(keyword);
      $('#search-form').submit();
    });

    console.log('Trang ch·ªß ƒë√£ ƒë∆∞·ª£c t·∫£i v√† kh·ªüi t·∫°o th√†nh c√¥ng');
  });
</script>
